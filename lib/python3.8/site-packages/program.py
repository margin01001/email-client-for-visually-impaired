#lib for reading email
import imaplib        

#lib for sending email                      
import smtplib

#email library is used to accessing message body
import email

#library to convert text to speech                                     
import gtts       

#this library is used to play the sound 
from playsound import playsound        

#as sr is modifying speech_recognition module
import speech_recognition as sr

#print(sr.__version__)                                  #print version of speech_recognition

def send(frome, to, p, body, subject):
    smtpserver.login(frome, p)
    m = f"Subject: {subject}\n\n{body}"   
    smtpserver.sendmail(frome, to, m)
    print("send")

#reading password from file.txt file
password = ""
with open("file.txt","r") as p:
    password = p.read()
#reading email from email.txt file
fromemail = ""
with open("email.txt","r") as e:
    fromemail = e.read()

#setting server to send email (instantiation) smtp-mail.outlook.com
smtpserver = smtplib.SMTP_SSL("smtp.gmail.com", 465)

#setting server to recieve email
imapserver = imaplib.IMAP4_SSL("imap.gmail.com", 993)  
imapserver.login(fromemail, password)
imapserver.select('INBOX')

gm = "Good Morning"
helps = "This program will help you to send or listen your emails."
option_1 = "say 2 if you want to send an email someone"
option_2 = "say 1 if you want to listen your all emails"
option_3 = "say 3 if you want to listen unread emails"
s4 = "say 4 if you want to listen again"
s5 = "say 5 if you want to exit"
wait = "wait for a second then speak and speak under 8 second"
say_email_address = "say email address of whom you want to send"
say_about_subject = "say something in subject"
say_about_body = "say something in body"

#passing gm string to "file" object
file = gtts.gTTS(gm)
#in this line of code we are saving gm string as a audio_input file in format mp3
file.save("gm.mp3")

file = gtts.gTTS(helps)
file.save("helps.mp3")

file = gtts.gTTS(option_1)                                      
file.save("send_option.mp3")                            

file = gtts.gTTS(option_2)
file.save("all_email_option.mp3")

file = gtts.gTTS(option_3)
file.save("unread_email_option.mp3")

file = gtts.gTTS(s4)
file.save("listen_again.mp3")

file = gtts.gTTS(s5)
file.save("exit.mp3")

file = gtts.gTTS(wait)
file.save("wait.mp3")

file = gtts.gTTS(say_email_address)
file.save("say_email_address.mp3")

file = gtts.gTTS(say_about_subject)
file.save("say_about_subject.mp3")

file = gtts.gTTS(say_about_body)
file.save("say_about_body.mp3")

s = '2'

playsound("gm.mp3")
playsound("helps.mp3")
playsound("send_option.mp3")
playsound("all_email_option.mp3")
playsound("unread_email_option.mp3")
playsound("listen_again.mp3")
playsound("exit.mp3" )

while s != "5" or s != 'five' or s !="price" or s!="live":
    #'Recognize' class
    print("speak")
    r = sr.Recognizer()     
    #turn on microphone to accept sound in port 0     
    #playsound("wait.mp3")
    mic=sr.Microphone(device_index = 2)      

    with mic as source:     
        r.adjust_for_ambient_noise(source)                  #(source, duration=0.5) 
        audio_input = r.listen(source)                      #take voice input             

    #this line of code will save our audio_input in s as a string
    s = r.recognize_google(audio_input)
    print(s)

    if s == '1' or s == 'one' or s == "van" or s == "gone":
        #selecting receiving type (eg- INBOX, FAVORITE, SPAM)
        #INBOX category is by default
        imapserver.select('INBOX')

        #search for ALL emails
        typ, data = imapserver.search(None, 'ALL')

        #This loop will print received email information
        #split is used to split string into a list
        for data in data[0].split():
            typ, data = imapserver.fetch(data, '(RFC822)')

            msg = email.message_from_bytes(data[0][1])

            print (msg["From"])
            file = gtts.gTTS(msg["From"])
            file.save("from_email.mp3")
            playsound("from_email.mp3")

            print (msg["Subject"])
            file = gtts.gTTS(msg["Subject"])
            file.save("Subject_email.mp3")
            playsound("Subject_email.mp3")

            print (msg["Date"])
            file.save("data_email.mp3")
            playsound("data_email.mp3")
            print ("")

    elif s == '2' or s == 'tu' or s == 'two' or s== 'to' or s == "Tum" or s == "Tu" or s == "tube" or s == "do":
        print(say_email_address)
        playsound("say_email_address.mp3")

        r=sr.Recognizer()     
        mic=sr.Microphone(device_index = 2)      

        with mic as source:     
            r.adjust_for_ambient_noise(source)                 
            audio_input = r.listen(source)         

        to = r.recognize_google(audio_input)
        to = to.replace(" ",'')
        print(to)

        print(say_about_subject)
        playsound("say_about_subject.mp3")

        r=sr.Recognizer()     
        mic=sr.Microphone(device_index = 2)      

        with mic as source:     
            r.adjust_for_ambient_noise(source)                 
            audio_input = r.listen(source)         

        subject = r.recognize_google(audio_input)
        print(subject)

        print(say_about_body)
        playsound("say_about_body.mp3")

        r=sr.Recognizer()     
        mic=sr.Microphone(device_index = 2)      

        with mic as source:     
            r.adjust_for_ambient_noise(source)                 
            audio_input = r.listen(source)         

        body = r.recognize_google(audio_input)
        print(body)
        
        send(fromemail, to, password, body, subject)

    elif s == "4" or s == "four" or s == "Ho":
        playsound("gm.mp3")
        playsound("helps.mp3")
        playsound("send_option.mp3")
        playsound("all_email_option.mp3")
        playsound("unread_email_option.mp3")
        playsound("listen_again.mp3")
        playsound("exit.mp3")

    elif s=="5" or s=="price" or s == "side" or s == "bhai" or s == "bike":
        break

smtpserver.quit()      
imapserver.close()
imapserver.logout()

